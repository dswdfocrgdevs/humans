{% load tags %}
<div class="modal-header">
    <!--begin::Modal title-->
    <h2>Applicants Requirements</h2>
    <!--end::Modal title-->
    <!--begin::Close-->
    <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">{% getIcon 'cross' 'fs-1' %}</div>
    <!--end::Close-->
</div>
<div class="modal-body">
    <div class="row mb-4">
        <!-- Main Information -->
        <div class="col-lg-3 col-md-4 col-sm-12">
            <h3 class="fw-bold text-primary">Main Information</h3>
            <p>Name <br><strong>{{ app.full_name|upper }}</strong></p>
            <p>Sex <br><strong>{{ app.gender }}</strong></p>
            <p>Position <br><strong>{{ app.position }}</strong></p>
            <p>Employment Status <br><strong>{{ app.emp_status }}</strong></p>
            <p>Program <br><strong>{{ app.program }}</strong></p>
            <p>Fundsource <br><strong>{{ app.fundsource }}</strong></p>
            <p>Salary Rate <br><strong>{{ app.salary }} - SG {{ app.salary_grade }} </strong></p>
        </div>

        <!-- Requirements and Actions -->
        <div class="col-lg-9 col-md-8 col-sm-12">
            {% if app.requirements_ok == 'Incomplete'%}
            <div class="alert alert-dismissible bg-light-danger d-flex flex-column flex-sm-row w-100 p-5 mb-10">
                <i class="ki-duotone ki-message-text-2 fs-2hx text-danger me-4 mb-5 mb-sm-0"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>                    <!--end::Icon-->
                <div class="d-flex flex-column pe-0 pe-sm-10">
                    <h4 class="fw-semibold">Incomplete Status</h4>
                    <span>Please submit the requirements on or before <strong>{{app.araf_due_date}}</strong></span>
                </div>
                <button type="button" class="position-absolute position-sm-relative m-2 m-sm-0 top-0 end-0 btn btn-icon ms-sm-auto" data-bs-dismiss="alert">
                    <i class="ki-duotone ki-cross fs-1 text-danger"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
            {%elif app.requirements_ok == 'Complete'%}
            <div class="alert alert-dismissible bg-light-success d-flex flex-column flex-sm-row w-100 p-5 mb-10">
                <i class="ki-duotone ki-pencil fs-2hx text-success me-4 mb-5 mb-sm-0"><span class="path1"></span><span class="path2"></span></i>
                <div class="d-flex flex-column pe-0 pe-sm-10">
                    <h4 class="fw-semibold">Completed Status</h4>
                    <span>The requirements checklist already completed!.</span>
                </div>
                <button type="button" class="position-absolute position-sm-relative m-2 m-sm-0 top-0 end-0 btn btn-icon ms-sm-auto" data-bs-dismiss="alert">
                    <i class="ki-duotone ki-cross fs-1 text-success"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
            {% endif %}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">{{ app.emp_status }} Requirements</h3>
                <div class="d-flex">
                    {% if app.requirements_ok == 'Incomplete'%}
                    <a href="{% url 'rsp:print_req_araf' pk %}" target="_blank" class="btn btn-sm btn-light-danger me-2 p-4">
                        <i class="fas fa-print"></i> Print ARAF
                    </a>
                    {% endif %}

                    <a href="{% url 'rsp:print_req_checklist' pk %}" target="_blank" class="btn btn-sm btn-light-success me-2 p-4">
                        <i class="fas fa-print"></i> Print Checklist
                    </a>

                    <!-- Dropdown Menu -->
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                           Download Actions {{app.emp_status}}
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="actionDropdown">
                            {% if app.emp_status == 'COS with ATH' or app.emp_status == 'Job Order Savings' or app.emp_status == 'COS Savings' %}
                                <li>
                                    <a class="dropdown-item" href="../../static/staticfiles/assets/templates/MOA-Template.docx" target="_blank">
                                        MOA Contract
                                    </a>
                                </li>
                            {% elif app.emp_status == 'Permanent' or app.emp_status == 'Regular Contractual' or app.emp_status == 'Contractual' %}
                                <li>
                                    <a class="dropdown-item" href="../../static/staticfiles/assets/templates/Contractual-template.doc" target="_blank">
                                        Contractual Contract
                                    </a>
                                </li>
                            {% endif %}
                            {% if app.emp_status == 'COS with ATH' or app.emp_status == 'Job Order Savings' or app.emp_status == 'COS Savings' %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="../../static/staticfiles/assets/templates/MOA-Requirements-Checklist.xlsx" target="_blank">
                                        Requirements to Comply
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>                    
                </div>
            </div>

            <!-- Compliance Form -->
            <form id="submitComplianceForm">
                <div class="table-responsive">
                   
                    <table class="table align-middle table-bordered table-hover table-striped">
                        <thead class="table-light">
                            <tr class="text-center" style="font-size: 12px;">
                                <th>
                                    Check if required
                                    <div class="d-flex flex-center mt-2">
                                        <div class="form-check form-check-sm">
                                            <input id="requirements-checklist-check-all" class="form-check-input" type="checkbox" checked>
                                        </div>
                                    </div>
                                </th>
                                <th>Requirements</th>
                                <th>Date Submitted<br>
                                    <small class="text-danger">Please fill this field to avoid errors.</small>
                                </th>
                                <th>Remarks<br>
                                    <small class="text-danger">Please fill this field to avoid errors.</small>
                                </th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% get_empstatus_hired_req app.emp_status as req %}
                            {% for row in req %}
                                {% getcompliance app.app_id row.id as compliance %}
                                {% checkcompliance app.app_id as check_compliance %}
                                {% get_is_required check_compliance compliance row as req_is_required %}
                                <tr id="{{ row.id }}">
                                    <input type="hidden" value="{{ row.id }}" name="req_id[]" id="req_id">
                                    <input type="hidden" value="{{ app.app_id }}" name="app_id[]" id="app_id">
                                    <td>
                                        <div class="d-flex flex-center">
                                            <div class="form-check form-check-sm">
                                                <input onchange="handleCheckboxChange(this)" class="form-check-input requirements-checklist-checkbox" name="is_required[]" type="checkbox" value="1" {% if req_is_required == 1 %}checked{% endif %}>
                                                <input type="hidden" name="is_required[]" value="0" {% if req_is_required == 1 %}disabled{% endif %}>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ row.name }}
                                    </td>
                                    <td class="text-center">
                                        <input type="date" class="date-compliance form-control form-control-sm {% if req_is_required is None %}opacity-50{% endif %}" name="date_compliance[]" value="{{ compliance.datetime|date:'Y-m-d' }}" {% if req_is_required is None %}readonly{% endif %} required>
                                    </td>
                                    <td class="text-center">
                                        <input type="text" class="date-remarkscompliance form-control form-control-sm {% if req_is_required is None %}opacity-50{% endif %}" name="date_remarkscompliance[]" value="{% if compliance %}{{ compliance.remarks }}{% endif %}" {% if req_is_required is None %}readonly{% endif %} required>
                                    </td>
                                    <td class="text-center">
                                        {% if req_is_required is None %} 
                                            <span class="text-black d-block">Not Applicable <i class="fas fa-info-circle"></i></span>
                                        {% else %}
                                            {% if compliance.datetime %}
                                                <span class="text-success d-block">Submitted <i class="fas fa-check-circle"></i></span>
                                                <hr class="p-0 m-0">
                                                <a href="#" class="text-danger mt-2" data-role="delete" data-id="[{{ row.id }}, {{ app.app_id }}, {{ app.id }}]">
                                                    Remove <i class="fas fa-times fa-lg"></i>
                                                </a>
                                            {% else %}
                                                <span class="text-warning d-block">Not Yet Submitted <i class="fas fa-times-circle"></i></span>
                                            {% endif %}
                                        {% endif %}
                                       
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Save Changes Button -->
                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-check"></i> Save Changes
                    </button>
                </div>
            </form>
            <div class="d-flex justify-content-start align-items-center" style="margin-top: -35px;">
                <form id="complete" class="me-3">
                    <input type="hidden" name="app_id" value="{{ app.id }}">
                    <button type="submit" class="btn btn-primary btn-sm" {% if app_hired or app.requirements_ok == 'Complete' %}disabled{% endif %}>
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-check-circle me-1"></i> Complete
                    </button>
                </form>
            
                <form id="not-complete">
                    <input type="hidden" id="app_id_not_completed" name="app_id_not_completed" value="{{ app.id }}">
                    <button type="submit" class="btn btn-danger btn-sm" {% if app.requirements_ok %}disabled{% endif %}>
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-times-circle me-1"></i> Not Complete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="kt_modal_new_target" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content rounded">
            <div class="modal-header pb-3 h-80px border-0 justify-content-end">
               
            </div>
            <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                <form id="kt_modal_new_target_form" class="form" action="#">
                    <div class="mb-13 text-center">
                        <h1 class="mb-3">Incomplete Details</h1>
                        <div class="text-muted fw-semibold fs-5">Provide details for the incomplete action on requirements checklist.</div>
                    </div>
                    <div class="d-flex flex-column mb-8 fv-row">
                        <label class="required fs-6 fw-semibold mb-2">Requirements Due Date</label>
                        <div class="position-relative d-flex align-items-center">
                            <i class="ki-duotone ki-calendar-8 fs-2 position-absolute mx-4">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                                <span class="path6"></span>
                            </i>
                            <input class="form-control form-control-solid ps-12" placeholder="Select a date" id="target_due_date" name="target_due_date" />
                        </div>
                    </div>
                    <div class="d-flex flex-column mb-8 fv-row">
                        <label class="required fs-6 fw-semibold mb-2">Remarks</label>
                        <textarea class="form-control form-control-solid" rows="3" id="target_remarks" name="target_remarks" placeholder="Type Target Details"></textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="kt_modal_new_target_cancel" class="btn btn-light me-3">Cancel</button>
                        <button type="button" id="kt_modal_new_target_submit" class="btn btn-primary">
                            <span class="indicator-label">Submit</span>
                            <span class="indicator-progress">Please wait... 
                            <span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $('#submitComplianceForm').on('submit', function(e){
        var form = new FormData(this);
        Swal.fire({
            title: "Are you sure",
            text: "You want update this requirements checklist?",
            icon: "info",
            showCancelButton: true,
            confirmButtonColor: "#3498DB",
            confirmButtonText: "Yes",
            closeOnConfirm: false,
            allowOutsideClick: false,
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.showLoading()
                $.ajax({
                    data        : form,
                    url         : "{% url 'rsp:view_hired_requirements' pk %}",
                    type        : 'POST',
                    cache       : false,
                    contentType : false,
                    processData : false
                })
                .done(function(data){
                    if (data){
                        Swal.fire({
							title: "Good job!",
							text: "Requirements status successfully changes!",
                          	icon: "info",
                          	confirmButtonColor: "#3498DB",
                        }).then((result) => {
                            if (result.isConfirmed) {
								$('#view-modal-requirements').modal('show').find('.modal-content').load("{% url 'rsp:view_hired_requirements' pk %}");
							}
                        });
                    }else{
                    	Swal.fire("Warning", data.error, "warning");
                    }
                });
            }
        });
        e.preventDefault();
    });

    $('#not-complete').on('submit', function(e){
		e.preventDefault();
        $('#kt_modal_new_target').modal('show');

        var KTModalNewTarget = function () {
            var submitButton;
            var cancelButton;
            var validator;
            var form;
            var modalIcomplete;
            var modalEl;

            var initForm = function() {
                var dueDate = $(form.querySelector('[name="target_due_date"]'));
                dueDate.flatpickr({
                    enableTime: false,
                    dateFormat: "Y-m-d",
                    onOpen: function(selectedDates, dateStr, instance) {
                        if (Swal.isVisible()) {
                            instance.close();
                        }
                    },
                });
            }

            var handleForm = function() {
                validator = FormValidation.formValidation(
                    form,
                    {
                        fields: {
                            target_due_date: {
                                validators: {
                                    notEmpty: {
                                        message: 'Target due date is required'
                                    }
                                }
                            },
                            target_remarks: {
                                validators: {
                                    notEmpty: {
                                        message: 'Remarks is required'
                                    }
                                }
                            },
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap: new FormValidation.plugins.Bootstrap5({
                                rowSelector: '.fv-row',
                                eleInvalidClass: '',
                                eleValidClass: ''
                            })
                        }
                    }
                );

                submitButton.addEventListener('click', function (e) {
                    e.preventDefault();

                    if (validator) {
                        validator.validate().then(function (status) {

                            if (status == 'Valid') {
                                submitButton.setAttribute('data-kt-indicator', 'on');

                                submitButton.disabled = true;

                                const app_id = $('#app_id_not_completed').val();
                                const target_remarks = $('#target_remarks').val();
                                const target_due_date = $('#target_due_date').val();

                                $.ajax({
                                    url: "{% url 'rsp:hiredreq_not_complete' %}",
                                    data: {
                                        app_id: app_id,
                                        remarks: target_remarks,
                                        due_date: target_due_date
                                    },
                                    type: "POST"
                                })
                                .done(function(data){
                                    submitButton.removeAttribute('data-kt-indicator');

                                    // Enable button
                                    submitButton.disabled = false;
                                    if(data.data == "success"){
                                        Swal.fire({
                                            title: "Information!",
                                            text: "Applicant requirements not-completed it will successfully notify to receiver!",
                                            icon: "success",
                                            confirmButtonColor: "#3498DB",
                                            allowOutsideClick: false,
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                $('.modal-backdrop').eq(1).remove();    
									            $('#kt_modal_new_target').modal('hide');
                                                $('#view-modal-requirements').modal('show').find('.modal-content').load("{% url 'rsp:view_hired_requirements' pk %}");
                                                $('#hired-table').DataTable().ajax.reload();
                                            }
                                        });
                                    }else{
                                        Swal.fire("Warning", data.error, "warning");
                                    }
                                });

                            } else {
                                Swal.fire({
                                    text: "Sorry, looks like there are some errors detected, please try again.",
                                    icon: "error",
                                    buttonsStyling: false,
                                    confirmButtonText: "Ok, got it!",
                                    customClass: {
                                        confirmButton: "btn btn-primary"
                                    }
                                });
                            }
                        });
                    }
                });

                cancelButton.addEventListener('click', function (e) {
                    e.preventDefault();

                    Swal.fire({
                        text: "Are you sure you would like to cancel?",
                        icon: "warning",
                        showCancelButton: true,
                        buttonsStyling: false,
                        confirmButtonText: "Yes, cancel it!",
                        cancelButtonText: "No, return",
                        focusCancel: false,
                        focusConfirm: false,
                        customClass: {
                            confirmButton: "btn btn-primary",
                            cancelButton: "btn btn-active-light"
                        }
                    }).then(function (result) {
                        if (result.value) {
                            form.reset();
                            $('.modal-backdrop').eq(1).remove();
                            $('#kt_modal_new_target').hide();
                        } else if (result.dismiss === 'cancel') {
                            Swal.fire({
                                text: "Your form has not been cancelled!.",
                                icon: "error",
                                buttonsStyling: false,
                                confirmButtonText: "Ok, got it!",
                                customClass: {
                                    confirmButton: "btn btn-primary",
                                }
                            });
                        }
                    });
                });
            }

            return {
                // Public functions
                init: function () {
                    // Elements
                    modalEl = document.querySelector('#kt_modal_new_target');

                    if (!modalEl) {
                        return;
                    }

                    modalIcomplete = new bootstrap.Modal(modalEl);

                    form = document.querySelector('#kt_modal_new_target_form');
                    submitButton = document.getElementById('kt_modal_new_target_submit');
                    cancelButton = document.getElementById('kt_modal_new_target_cancel');

                    initForm();
                    handleForm();
                }
            };
        }();

        KTUtil.onDOMContentLoaded(function () {
            KTModalNewTarget.init();
        });	
	});

    $('#complete').on('submit', function(e){
		e.preventDefault();

        let validate_fields = true;
        $('.requirements-checklist-checkbox').each(function(d) {
            if($(this).is(':checked')) {
                const dateComplianceField = $(this).closest('td').siblings().find('.date-compliance');
                const dateRemarksComplianceField = $(this).closest('td').siblings().find('.date-remarkscompliance');
                if(dateComplianceField.val() == '' || dateRemarksComplianceField.val() == '') validate_fields = false;
            }
        });

        if(!validate_fields) {
            Swal.fire("Warning", "Please fill-in all required fields", "warning");
            return;
        }

    	var form = new FormData(this);
		Swal.fire({
		  title: "Confirmation",
		  text: "Are you sure that this applicant done with the requirements?",
		  icon: "info",
		  showCancelButton: true,
		  confirmButtonColor: "#3498DB",
		  confirmButtonText: "Yes",
		  allowOutsideClick: false,
		  showLoaderOnConfirm: true,
		  preConfirm: function (){
			return $.ajax({
				data: form,
				url: "{% url 'rsp:hiredreq_complete' %}",
				type        : 'POST',
				cache       : false,
				contentType : false,
				processData : false,
			});
		},
		}).then(function (data){
			if(data.value.data == "success"){
				Swal.fire({
				  title: "Good job!",
				  text: "Applicant requirements successfully completed!",
				  icon: "success",
				  confirmButtonColor: "#3498DB",
				  allowOutsideClick: false,
				}).then((result) => {
					if (result.isConfirmed) {
						$('#view-modal-requirements').modal('show').find('.modal-content').load("{% url 'rsp:view_hired_requirements' pk %}");
                        $('#hired-table').DataTable().ajax.reload();
					}
				});
			}else{
				Swal.fire("Warning", data.value.error, "warning");
			}
		});
	});

    handleCheckboxAllChange();

    $('#requirements-checklist-check-all').on('change', function() {
        const status = $(this).is(':checked');
        $('.requirements-checklist-checkbox').each(function() {
            $(this).prop('checked', status);
            $(this).next('input[type="hidden"]').prop('disabled', status);
            handleCheckboxChange(this);
        });
    })

    function handleCheckboxAllChange() {
        const requirements_length = $('.requirements-checklist-checkbox').length;
        let count_check = 0;
        
        $('.requirements-checklist-checkbox').each(function(d) {
            if($(this).is(':checked')) count_check++; 
        });

        $("#requirements-checklist-check-all").prop('checked', requirements_length == count_check ? true : false)
    }

    function handleCheckboxChange(checkbox) {
        const hiddenInput = checkbox.nextElementSibling;
        const dateComplianceField = $(checkbox).closest('td').siblings().find('.date-compliance');
        const dateRemarksComplianceField = $(checkbox).closest('td').siblings().find('.date-remarkscompliance');

        dateComplianceField.prop('readonly',!checkbox.checked);
        dateRemarksComplianceField.prop('readonly',!checkbox.checked);

        handleCheckboxAllChange();
           
        if (checkbox.checked) {
            hiddenInput.disabled = true;
            dateComplianceField.removeClass('opacity-50');
            dateRemarksComplianceField.removeClass('opacity-50');
        } else {
            hiddenInput.disabled = false;
            dateComplianceField.addClass('opacity-50');
            dateRemarksComplianceField.addClass('opacity-50');
        }
    }

    
</script>